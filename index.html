import telegram
from telegram import Update
from telegram.ext import ApplicationBuilder, ContextTypes, MessageHandler, filters
import traceback 
import asyncio # ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï‡ßç‡¶∞‡ßã‡¶®‡¶æ‡¶∏ ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá

# --- 1. Put your BotFather token here ---
BOT_TOKEN = "8578011559:AAEmUR2SkkA2fINVeAz5PKrkxFoKXKpbD-w"  # MUST be changed with your actual token

# --- 2. Function to Filter Messages (Links and Spam Keywords) ---
async def message_filter(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
    if not update.message or not update.message.from_user:
        return

    user_id = update.message.from_user.id
    chat_id = update.effective_chat.id
    
    # --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞: Admin/Owner Exemption Check ---
    try:
        # ‡ßß. ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶ü‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®
        administrators = await context.bot.get_chat_administrators(chat_id)
        
        # ‡ß®. ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡¶ø‡¶®‡¶æ ‡¶§‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
        is_admin = any(admin.user.id == user_id for admin in administrators)

        if is_admin:
            # ‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ ‡¶ì‡¶®‡¶æ‡¶∞ ‡¶π‡¶®, ‡¶§‡¶¨‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
            print(f"Admin/Owner bypass: {update.message.from_user.first_name}")
            return
            
    except telegram.error.BadRequest as e:
        # ‡¶Ø‡¶¶‡¶ø ‡¶¨‡¶ü‡¶ü‡¶ø ‡¶®‡¶ø‡¶ú‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶æ ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶è‡¶á ‡¶è‡¶∞‡¶∞ ‡¶Ü‡¶∏‡ßá‡•§ ‡¶∏‡ßá‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡ßá ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶ö‡¶≤‡¶§‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
        print(f"Could not check admin status (Bot might not be admin): {e}")
        pass # ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶ö‡¶æ‡¶≤‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶®

    # ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá (‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶õ‡¶ø‡¶≤), ‡¶§‡¶¨‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®
    if not update.message.text:
        return
        
    # ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ï‡ßá ‡¶õ‡ßã‡¶ü ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
    message_text_lower = update.message.text.lower()

    # --- Spam Keyword List (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá) ---
    spam_keywords = [
        # ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® Keywords:
        "scam", 
        "rug", 
        "rug pull", 
        "rugpull", 
        "fake project", 
        "scam token", 
        "scam coin", 
        "dm me",
        "free money", 
        "win cash", 
        "private key",
        # ‡¶®‡¶§‡ßÅ‡¶® Keywords:
        "fake",
        "scm",
        "feke"
    ]

    # --- 1. Link Check ---
    is_spam_link = False
    if update.message.entities:
        for entity in update.message.entities:
            # URL ‡¶¨‡¶æ Text_Link ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
            if entity.type in ['url', 'text_link']:
                is_spam_link = True
                break
    
    # --- 2. Spam Keyword Check ---
    is_spam_text = any(keyword in message_text_lower for keyword in spam_keywords)
    
    # --- Delete message if either link or spam keyword is found ---
    if is_spam_link or is_spam_text:
        try:
            await update.message.delete()
            # ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            reason = "Link" if is_spam_link else "Spam Keyword"
            print(f"Banned content deleted ({reason}): {update.message.from_user.first_name}")
            
        except telegram.error.BadRequest as e:
            # ‡¶¨‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡¶æ ‡¶™‡ßá‡¶≤‡ßá ‡¶è‡¶∞‡¶∞ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            print(f"Could not delete message: {e}")
        return 


# --- 3. Function to Welcome New Members ---
async def welcome_new_members(update: Update, context: ContextTypes.DEFAULT_TYPE):
    for member in update.message.new_chat_members:
        # Check if the new member is not the bot itself
        if member.id != context.bot.id:
            # HTML parsing is used to mention the user properly
            welcome_message = f"üêíWelcome to the official community üëã {member.mention_html()}! üåü\n\nThis group is for discussion and updates only.  \nNo scams, fake projects, or misleading information allowed."
            
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text=welcome_message,
                parse_mode='HTML'
            )
        else:
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text="ü§ñ Bot activated successfully.\nAutomated spam and scam protection is now active to help keep the community secure."
            )

# --- 4. Main Function to Run the Bot ---
def main():
    try:
        application = ApplicationBuilder().token(BOT_TOKEN).build()

        # Handler for filtering links and spam keywords
        filter_handler = MessageHandler(filters.ALL & (~filters.COMMAND), message_filter)
        application.add_handler(filter_handler)

        # Handler for new members joining the group
        welcome_handler = MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, welcome_new_members)
        application.add_handler(welcome_handler)
        
        print("Bot is running... Press Ctrl+C to stop")
        application.run_polling()
        
    except Exception as e:
        # ‡¶è‡¶∞‡¶∞ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶ì‡ßü‡¶æ ‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        print("\n--- AN ERROR OCCURRED ---")
        print(f"Error Type: {type(e).__name__}")
        print(f"Error Message: {e}")
        print("\n--- Traceback ---")
        traceback.print_exc() 
        input("\nPress ENTER to close the window...")


if __name__ == '__main__':
    main()
